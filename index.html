<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading App</title>
    <link rel="stylesheet" href="style.css">
<script src="https://unpkg.com/lightweight-charts@4.2.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
<script>
    const token = localStorage.getItem("jwt");
    if (!token) {
        window.location.href = "login.html";
    }
    </script>
</head>
<body data-color-scheme="dark">
    <!-- Top Navigation -->
    <header class="top-nav">
        <div class="nav-left">
            <div class="logo">
                <span class="logo-text">Trading App</span>
            </div>
            <button id="openStockModal" class="btn btn--secondary btn--sm">Select Stock</button>            
            <div class="timeframe-buttons">
                <button class="btn btn-timeframe" data-timeframe="1m">1m</button>
                <button class="btn btn-timeframe" data-timeframe="5m">5m</button>
                <button class="btn btn-timeframe" data-timeframe="15m">15m</button>
                <button class="btn btn-timeframe" data-timeframe="30m">30m</button>
                <button class="btn btn-timeframe" data-timeframe="1h">1h</button>
                <button class="btn btn-timeframe" data-timeframe="4h">4h</button>
                <button class="btn btn-timeframe" data-timeframe="1D">1D</button>
                <button class="btn btn-timeframe" data-timeframe="1W">1W</button>
            </div>
        </div>
        <div class="nav-center">
            <div class="chart-controls">
                <button id="uploadCSVBtn" class="btn btn--secondary">
                    üìÑ Upload CSV
                </button>
                <input type="file" id="csvUpload" accept=".csv" style="display: none;">
                <button class="btn btn--secondary" id="toggleRealtime">üü¢ Go Live</button>
                <button class="btn btn--secondary" id="autoScale">üìè Auto Scale</button>
                <button class="btn btn--secondary" id="streamFromServer">üì° Simulate </button>
                <button class="btn btn--secondary" id="fetchAllData">üìä Historical Data</button>
                <button class="btn btn--secondary" id="stopSimulation" style="display:none;">‚èπ Stop</button>
            </div>            
        </div>
        <div class="nav-right">
            <button class="btn btn--secondary" id="exportChart">üíæ Export</button>
        </div>
    </header>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar - Drawing Tools -->
        <aside class="left-sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">Drawing Tools</h3>
                <div class="drawing-tools">
                    <button class="tool-btn" data-tool="cursor" title="Cursor">
                        <span class="tool-icon">üñ±Ô∏è</span>
                        <span class="tool-label">Cursor</span>
                    </button>
                    <button class="tool-btn" data-tool="trendline" title="Trend Line">
                        <span class="tool-icon">üìà</span>
                        <span class="tool-label">Trend Line</span>
                    </button>
                    <button class="tool-btn" data-tool="horizontal" title="Horizontal Line">
                        <span class="tool-icon">‚ûñ</span>
                        <span class="tool-label">Horizontal</span>
                    </button>
                    <button class="tool-btn" data-tool="vertical" title="Vertical Line">
                        <span class="tool-icon">üìè</span>
                        <span class="tool-label">Vertical</span>
                    </button>
                    <button class="tool-btn" data-tool="rectangle" title="Rectangle">
                        <span class="tool-icon">‚¨õ</span>
                        <span class="tool-label">Rectangle</span>
                    </button>
                    <button class="tool-btn" data-tool="text" title="Text">
                        <span class="tool-icon">üìù</span>
                        <span class="tool-label">Text</span>
                    </button>
                </div>
                <button class="btn btn--secondary btn--full-width" id="clearDrawings">
                    üóëÔ∏è Clear All
                </button>
            </div>
        </aside>

        <!-- Chart Area -->
        <main class="chart-container">
            <div class="chart-header">
                <div class="chart-info">
                    <span class="current-symbol"></span>
                    <!--<span class="current-price">---</span>
                    <span class="price-change">---</span>-->
                </div>
                <div class="chart-style-controls">
                    <button class="btn btn--secondary chart-style-btn active" data-style="candlestick">üìä Candles</button>
                    <button class="btn btn--secondary chart-style-btn" data-style="line">üìà Line</button>
                    <button class="btn btn--secondary chart-style-btn" data-style="area">üèîÔ∏è Area</button>
                </div>
            </div>
            <div id="chart" class="chart-element">
            </div>
            <div class="status-bar">
                <div class="status-left">
                    <span id="connectionStatus" class="status status--success">üü¢ Connected</span>
                    <span id="dataMode">üìä Historical Data</span>
                </div>
                <div class="status-right">
                    <span id="crosshairInfo">Move cursor to see price info</span>
                </div>
            </div>
            <div id="ohlcTooltip" class="ohlc-tooltip"></div>
        </main>

        <!-- Right Sidebar - Indicators & Watchlist -->
        <aside class="right-sidebar">
            <div class="sidebar-section">
                <h3 class="sidebar-title">Indicators</h3>
                <div class="indicators-list">
                    <div class="indicator-item">
                        <label class="indicator-checkbox">
                            <input type="checkbox" id="sma20" data-indicator="sma20">
                            <span class="checkmark"></span>
                            SMA 20
                        </label>
                        <div class="indicator-color" style="background-color: #ffeb3b;"></div>
                    </div>
                    <div class="indicator-item">
                        <label class="indicator-checkbox">
                            <input type="checkbox" id="sma50" data-indicator="sma50">
                            <span class="checkmark"></span>
                            SMA 50
                        </label>
                        <div class="indicator-color" style="background-color: #2196f3;"></div>
                    </div>
                </div>
            </div>
            <div class="sidebar-section">
                <h3 class="sidebar-title">Watchlist</h3>
                <div class="watchlist">
                    <div class="watchlist-item">
                        <span class="symbol">AAPL</span>
                        <span class="price">Loading...</span>
                        <span class="change">--</span>
                    </div>
                    <div class="watchlist-item">
                        <span class="symbol">GOOGL</span>
                        <span class="price">Loading...</span>
                        <span class="change">--</span>
                    </div>
                    <div class="watchlist-item">
                        <span class="symbol">TSLA</span>
                        <span class="price">Loading...</span>
                        <span class="change">--</span>
                    </div>
                </div>
                
            </div>
        </aside>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <span class="loading-text">Loading chart data...</span>
    </div>

    <script src="app.js"></script>
    <script>
        function openChartTabsForSelectedSymbols() {
            const sel = document.getElementById('symbolSelect');
            if (!sel) return alert('Symbol selector not found');
            const symbols = Array.from(sel.selectedOptions).map(o => o.value).filter(Boolean);
            if (!symbols.length) return alert('Select at least one symbol');
        
            // Max tabs safety
            const MAX_TABS = 12;
            if (symbols.length > MAX_TABS) {
                if (!confirm(`Open ${symbols.length} tabs? This may be heavy. Continue?`)) return;
            }
        
            // Open each symbol in a new tab, passing symbol in query param
            symbols.forEach(sym => {
                window.open(`chart.html?symbol=${encodeURIComponent(sym)}`, `_blank`);
            });
        }

        </script>
        <!-- STOCK SELECTION MODAL -->
<div id="stockModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h2 class="modal-title">Select Stocks</h2>

        <div class="stock-list-container">
            <ul id="stockList" class="stock-list">
                <li><label><input type="checkbox" value="Banknifty"> Banknifty</label></li>
                <li><label><input type="checkbox" value="AAPL"> AAPL</label></li>
                <li><label><input type="checkbox" value="GOOGL"> GOOGL</label></li>
                <li><label><input type="checkbox" value="TSLA"> TSLA</label></li>
                <li><label><input type="checkbox" value="MSFT"> MSFT</label></li>
                <li><label><input type="checkbox" value="AMZN"> AMZN</label></li>
                <li><label><input type="checkbox" value="NVDA"> NVDA</label></li>
                <li><label><input type="checkbox" value="META"> META</label></li>
            </ul>
        </div>

        <div class="modal-buttons">
            <button id="subscribeBtn" class="btn btn--secondary">Subscribe</button>
            <button id="unsubscribeBtn" class="btn btn--outline">Unsubscribe</button>
            <button id="closeStockModal" class="btn btn--danger">Close</button>
        </div>
    </div>
</div>
<script>
    const modal = document.getElementById("stockModal");
    const openBtn = document.getElementById("openStockModal");
    const closeBtn = document.getElementById("closeStockModal");
    
    openBtn.addEventListener("click", () => {
        modal.classList.remove("hidden");
    });
    
    closeBtn.addEventListener("click", () => {
        modal.classList.add("hidden");
    });
    </script>
<script>
    document.getElementById("uploadCSVBtn").onclick = () => {
    document.getElementById("csvUpload").click();
    };

    document.getElementById("subscribeBtn").addEventListener("click", () => {
        window.tradingApp.subscribeSelectedSymbols();
    });
    
    document.getElementById("unsubscribeBtn").addEventListener("click", () => {
        window.tradingApp.unsubscribeSelectedSymbols();
    });
    document.addEventListener("DOMContentLoaded", function() {
    document.getElementById("fetchAllData").addEventListener("click", () => {
        window.tradingApp.loadFullHistory(window.tradingApp.currentSymbol);
    });

    document.getElementById("streamFromServer").addEventListener("click", () => {
        window.tradingApp.startBrokerStreamingDirect(window.tradingApp.currentSymbol);
    });
});

    </script> 
</body>
</html>
